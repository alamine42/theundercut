{% extends "base.html" %}
{% block title %}{{ season }} Championship Standings{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.1.6/css/dataTables.dataTables.min.css">
<style>
  /* DataTables stark theme overrides */
  table.dataTable thead th {
    background: var(--ink) !important;
    color: var(--paper) !important;
    border: 2px solid var(--ink) !important;
  }
  table.dataTable tbody tr:hover {
    background: var(--ink) !important;
  }
  table.dataTable tbody tr:hover td {
    color: var(--paper) !important;
  }
  table.dataTable tbody td {
    border: 1px solid var(--border-light) !important;
  }
  .dataTables_wrapper .dataTables_filter input {
    border: 2px solid var(--ink);
    padding: 0.45rem 0.85rem;
    font-size: 0.85rem;
    font-family: 'IBM Plex Mono', monospace;
    background: var(--paper);
    color: var(--ink);
  }
  .dataTables_wrapper .dataTables_filter input:focus {
    outline: none;
    border-color: var(--accent);
  }
  .dataTables_wrapper .dataTables_info {
    color: var(--muted);
    font-size: 0.8rem;
  }
  .dataTables_wrapper .dataTables_filter label {
    color: var(--ink);
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    border: 2px solid var(--ink) !important;
    background: var(--paper) !important;
    color: var(--ink) !important;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: var(--ink) !important;
    color: var(--paper) !important;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: var(--accent) !important;
    border-color: var(--accent) !important;
    color: var(--paper) !important;
  }
</style>
{% endblock %}

{% block content %}
<section class="page-hero">
  <header>
    <div>
      <p class="subtitle">Formula 1 World Championship</p>
      <h1>{{ season }} Season</h1>
    </div>
    <div style="text-align: right;">
      <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted);">Season Progress</span>
      <p style="font-size: 1.75rem; font-family: 'IBM Plex Serif', serif; font-weight: 700; color: var(--ink); margin: 0.25rem 0 0;" id="metric-progress">--/--</p>
    </div>
  </header>
  <div class="hero-stats">
    <div class="hero-stat">
      <span>Championship Leader</span>
      <strong id="metric-leader">---</strong>
    </div>
    <div class="hero-stat">
      <span>Points</span>
      <strong id="metric-leader-pts">--</strong>
    </div>
    <div class="hero-stat">
      <span>Gap to P2</span>
      <strong id="metric-gap">--</strong>
    </div>
    <div class="hero-stat">
      <span>Constructor Leader</span>
      <strong id="metric-constructor">---</strong>
    </div>
  </div>
</section>

<section class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>Driver Championship</h2>
    <button type="button" class="btn btn-outline" onclick="toggleMetricsKey()">
      Metrics Key
    </button>
  </div>

  <div id="metrics-key" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: var(--ink); font-size: 0.85rem; border: 2px solid var(--ink);">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.6rem; color: var(--paper);">
      <div><strong style="color: var(--accent);">Pts</strong> Points Total</div>
      <div><strong style="color: var(--accent);">L5</strong> Points Last 5 Races</div>
      <div><strong style="color: var(--accent);">Proj</strong> Projected Season Total</div>
      <div><strong style="color: var(--accent);">Races</strong> Total Races</div>
      <div><strong style="color: var(--accent);">Poles</strong> Pole Positions</div>
      <div><strong style="color: var(--accent);">ASP</strong> Avg Starting Position</div>
      <div><strong style="color: var(--accent);">AFP</strong> Avg Finishing Position</div>
      <div><strong style="color: var(--accent);">PPR</strong> Points Per Race</div>
      <div><strong style="color: var(--accent);">+/-</strong> Positions Gained/Lost</div>
    </div>
  </div>

  <div style="overflow-x: auto;">
    <table id="driver-standings" class="data-table">
      <thead>
        <tr>
          <th>Pos</th>
          <th>Driver</th>
          <th>Team</th>
          <th>Pts</th>
          <th>L5</th>
          <th>Proj</th>
          <th>Races</th>
          <th>Poles</th>
          <th>ASP</th>
          <th>AFP</th>
          <th>PPR</th>
          <th>+/-</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="12" style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading standings...</td></tr>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Constructor Championship</h2>
  <div style="overflow-x: auto;">
    <table id="constructor-standings" class="data-table">
      <thead>
        <tr>
          <th>Pos</th>
          <th>Constructor</th>
          <th>Pts</th>
          <th>L5</th>
          <th>Proj</th>
          <th>Wins</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading standings...</td></tr>
      </tbody>
    </table>
  </div>
</section>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.1.6/js/dataTables.min.js"></script>

<script>
const SEASON = {{ season }};
let racesRemaining = 0;
let racesCompleted = 0;

function toggleMetricsKey() {
  const panel = document.getElementById('metrics-key');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function setMetric(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

async function loadStandings() {
  try {
    const resp = await fetch(`/api/v1/standings/${SEASON}`);
    if (!resp.ok) throw new Error('Failed to load standings');
    const data = await resp.json();

    racesCompleted = data.races_completed || 0;
    racesRemaining = data.races_remaining || 0;

    renderDriverStandings(data.drivers || []);
    renderConstructorStandings(data.constructors || []);
    updateHeroMetrics(data);
  } catch (err) {
    console.error('Error loading standings:', err);
    document.querySelector('#driver-standings tbody').innerHTML =
      '<tr><td colspan="12" style="text-align: center; color: #C41E3A; padding: 2rem;">Failed to load standings</td></tr>';
  }
}

function renderDriverStandings(drivers) {
  const tbody = document.querySelector('#driver-standings tbody');
  if (!drivers.length) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; color: var(--text-muted);">No data available</td></tr>';
    return;
  }

  tbody.innerHTML = drivers.map((d, i) => {
    const projPts = Math.round(d.points + (racesRemaining * (d.pts_last_5 / 5)));
    return `
      <tr>
        <td>${i + 1}</td>
        <td><strong>${d.driver_name}</strong></td>
        <td>${d.constructor_name}</td>
        <td><strong>${d.points}</strong></td>
        <td>${d.pts_last_5 || 0}</td>
        <td>${projPts}</td>
        <td>${d.total_races || 0}</td>
        <td>${d.poles || 0}</td>
        <td>${(d.avg_start_pos || 0).toFixed(1)}</td>
        <td>${(d.avg_finish_pos || 0).toFixed(1)}</td>
        <td>${(d.points_per_race || 0).toFixed(1)}</td>
        <td style="color: ${d.positions_gained >= 0 ? 'var(--success)' : 'var(--error)'}">
          ${d.positions_gained >= 0 ? '+' : ''}${d.positions_gained || 0}
        </td>
      </tr>
    `;
  }).join('');

  if ($.fn.DataTable.isDataTable('#driver-standings')) {
    $('#driver-standings').DataTable().destroy();
  }
  $('#driver-standings').DataTable({
    order: [[3, 'desc']],
    paging: false,
    info: false,
    scrollX: true
  });
}

function renderConstructorStandings(constructors) {
  const tbody = document.querySelector('#constructor-standings tbody');
  if (!constructors.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No data available</td></tr>';
    return;
  }

  tbody.innerHTML = constructors.map((c, i) => {
    const projPts = Math.round(c.points + (racesRemaining * (c.pts_last_5 / 5)));
    return `
      <tr>
        <td>${i + 1}</td>
        <td><strong>${c.constructor_name}</strong></td>
        <td><strong>${c.points}</strong></td>
        <td>${c.pts_last_5 || 0}</td>
        <td>${projPts}</td>
        <td>${c.wins || 0}</td>
      </tr>
    `;
  }).join('');

  if ($.fn.DataTable.isDataTable('#constructor-standings')) {
    $('#constructor-standings').DataTable().destroy();
  }
  $('#constructor-standings').DataTable({
    order: [[2, 'desc']],
    paging: false,
    searching: false,
    info: false,
    scrollX: true
  });
}

function updateHeroMetrics(data) {
  const drivers = data.drivers || [];
  const constructors = data.constructors || [];
  const total = (data.races_completed || 0) + (data.races_remaining || 0);

  setMetric('metric-progress', `${data.races_completed || 0}/${total || 24}`);

  if (drivers.length >= 2) {
    setMetric('metric-leader', drivers[0].driver_name.split(' ').pop()); // Last name
    setMetric('metric-leader-pts', drivers[0].points);
    const gap = drivers[0].points - drivers[1].points;
    setMetric('metric-gap', `+${gap}`);
  }

  if (constructors.length) {
    setMetric('metric-constructor', constructors[0].constructor_name);
  }
}

document.addEventListener('DOMContentLoaded', loadStandings);
</script>
{% endblock %}
