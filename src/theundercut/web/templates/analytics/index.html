{% extends "base.html" %}
{% block title %}Race Analytics – {{ season }} Round {{ round }}{% endblock %}

{% block content %}
<section class="page-hero">
  <header>
    <div>
      <p class="subtitle">Race Telemetry</p>
      <h1>Season {{ season }} · Round {{ round }}</h1>
    </div>
    <div style="text-align: right;">
      <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted);">Avg. Gap to Leader</span>
      <p style="font-size: 1.75rem; font-family: 'IBM Plex Serif', serif; font-weight: 700; color: var(--ink); margin: 0.25rem 0 0;" id="metric-delta">+0.000s</p>
    </div>
  </header>
  <div class="hero-stats">
    <div class="hero-stat">
      <span>Drivers</span>
      <strong id="metric-drivers">--</strong>
    </div>
    <div class="hero-stat">
      <span>Fastest Lap</span>
      <strong id="metric-fastest">--.--s</strong>
    </div>
    <div class="hero-stat">
      <span>Lap Window</span>
      <strong id="metric-laps">—</strong>
    </div>
    <div class="hero-stat">
      <span>Total Stints</span>
      <strong id="metric-stints">--</strong>
    </div>
  </div>
</section>

<section class="card">
  <h2>Driver Filter</h2>
  <div id="driver-filter" data-populated="false" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
    <span style="color: var(--text-muted); font-size: 0.85rem;">Loading drivers...</span>
  </div>
</section>

<div class="grid-2">
  <section class="card" style="grid-column: span 2;">
    <h2>Lap Time Progression</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: -0.5rem;">Lap times across the race distance</p>
    <div class="chart-container chart-container-lg">
      <div class="chart-loading">Loading chart...</div>
      <canvas id="lapTimeChart"></canvas>
    </div>
  </section>

  <section class="card">
    <h2>Pace Comparison</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: -0.5rem;">Delta to fastest driver</p>
    <div class="chart-container">
      <div class="chart-loading">Loading chart...</div>
      <canvas id="paceComparisonChart"></canvas>
    </div>
  </section>

  <section class="card">
    <h2>Driver Grades</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: -0.5rem;">Performance metrics radar</p>
    <div class="chart-container">
      <div class="chart-loading">Loading chart...</div>
      <canvas id="driverGradesRadar"></canvas>
    </div>
  </section>

  <section class="card" style="grid-column: span 2;">
    <h2>Stint Strategy</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: -0.5rem;">Tire compound windows</p>
    <div class="chart-container chart-container-lg">
      <div class="chart-loading">Loading chart...</div>
      <canvas id="stintTimelineChart"></canvas>
    </div>
  </section>
</div>

<script>
  window.chartInstances = {};

  document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
  });

  function getSelectedDrivers() {
    const checkboxes = document.querySelectorAll('input[name="drivers"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }

  function buildApiUrl() {
    const base = '/api/v1/analytics/{{ season }}/{{ round }}';
    const drivers = getSelectedDrivers();
    if (drivers.length === 0) return base;
    const params = drivers.map(d => `drivers=${encodeURIComponent(d)}`).join('&');
    return `${base}?${params}`;
  }

  function loadAnalyticsData() {
    const url = buildApiUrl();

    document.querySelectorAll('.chart-container').forEach(el => {
      const canvas = el.querySelector('canvas');
      if (canvas) canvas.style.display = 'none';
      const loader = el.querySelector('.chart-loading');
      if (loader) {
        loader.style.display = 'flex';
        loader.textContent = 'Loading chart...';
        loader.classList.remove('chart-error');
      }
    });

    fetch(url)
      .then(r => r.json())
      .then(data => {
        populateDriverFilter(data.laps);
        updateHeroMetrics(data);
        renderLapTimeChart(data);
        renderPaceComparisonChart(data);
        renderStintTimelineChart(data);
        renderDriverGradesRadar(data);
      })
      .catch(err => {
        console.error('Failed to load analytics:', err);
        document.querySelectorAll('.chart-container').forEach(el => {
          const loader = el.querySelector('.chart-loading');
          if (loader) {
            loader.textContent = 'Failed to load data';
            loader.style.color = 'var(--stripe-red)';
          }
        });
      });
  }

  function populateDriverFilter(laps) {
    const drivers = [...new Set(laps.map(l => l.driver))].sort();
    const container = document.getElementById('driver-filter');

    if (container.dataset.populated === 'true') return;
    container.dataset.populated = 'true';

    const chipMarkup = drivers.map(driver => `
      <label class="chip" style="cursor: pointer;">
        <input type="checkbox" name="drivers" value="${driver}" checked onchange="onDriverFilterChange()" style="accent-color: var(--accent);">
        <span>${driver}</span>
      </label>
    `).join('');

    const actions = `
      <div style="margin-left: 0.5rem; display: flex; gap: 0.75rem;">
        <button type="button" onclick="selectAllDrivers()" class="btn btn-outline" style="padding: 0.35rem 0.75rem;">All</button>
        <button type="button" onclick="selectNoDrivers()" class="btn btn-outline" style="padding: 0.35rem 0.75rem;">Clear</button>
      </div>
    `;

    container.innerHTML = chipMarkup + actions;
  }

  function selectAllDrivers() {
    document.querySelectorAll('input[name="drivers"]').forEach(cb => cb.checked = true);
    onDriverFilterChange();
  }

  function selectNoDrivers() {
    document.querySelectorAll('input[name="drivers"]').forEach(cb => cb.checked = false);
    onDriverFilterChange();
  }

  let filterDebounce = null;
  function onDriverFilterChange() {
    clearTimeout(filterDebounce);
    filterDebounce = setTimeout(() => {
      loadAnalyticsData();
    }, 300);
  }

  function setMetric(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function updateHeroMetrics(data) {
    const laps = data.laps || [];
    const grades = data.driver_pace_grades || [];
    const stints = data.stints || [];

    const driverCount = new Set(laps.map(l => l.driver)).size || grades.length || 0;
    setMetric('metric-drivers', driverCount ? driverCount.toString().padStart(2, '0') : '--');

    const fastestLap = laps.reduce((min, lap) => {
      if (!lap.lap_ms || lap.lap_ms <= 0) return min;
      return Math.min(min, lap.lap_ms);
    }, Infinity);
    setMetric('metric-fastest', fastestLap !== Infinity ? `${(fastestLap / 1000).toFixed(3)}s` : '--.--s');

    const maxLap = laps.reduce((max, lap) => Math.max(max, lap.lap || 0), 0);
    setMetric('metric-laps', maxLap ? `1-${maxLap}` : '—');

    setMetric('metric-stints', stints.length ? stints.length.toString().padStart(2, '0') : '00');

    if (grades.length) {
      const avgDelta = grades.reduce((sum, g) => sum + (g.pace_delta_ms || 0), 0) / grades.length;
      setMetric('metric-delta', `+${(avgDelta / 1000).toFixed(3)}s`);
    } else {
      setMetric('metric-delta', '+0.000s');
    }
  }
</script>

{% include "components/_chart_scripts.html" %}
{% endblock %}
