{% extends "base.html" %}
{% block title %}Analytics {{ season }} – Round {{ round }}{% endblock %}

{% block content %}
<div>
  <section class="telemetry-hero">
    <header>
      <div>
        <p class="text-sm tracking-[0.4em] uppercase text-[var(--text-muted)]">Race telemetry</p>
        <h1 class="text-4xl font-semibold tracking-[0.18em]">Season {{ season }} · Round {{ round }}</h1>
      </div>
      <div class="text-right">
        <p class="text-xs uppercase tracking-[0.35em] text-[var(--text-muted)]">Live delta</p>
        <p class="text-3xl font-semibold text-[var(--accent-amber)]" id="metric-delta">+0.000s</p>
        <small class="text-[var(--text-muted)]">Fastest benchmark</small>
      </div>
    </header>
    <div class="hero-meta">
      <div>
        <span>Active Drivers</span>
        <strong id="metric-drivers">--</strong>
      </div>
      <div>
        <span>Fastest Lap</span>
        <strong id="metric-fastest">--.--s</strong>
      </div>
      <div>
        <span>Lap Window</span>
        <strong id="metric-laps">—</strong>
      </div>
      <div>
        <span>Total Stints</span>
        <strong id="metric-stints">--</strong>
      </div>
    </div>
  </section>

  <section class="control-panel">
    <h2>Driver matrix</h2>
    <div id="driver-filter" data-populated="false">
      <span class="text-[var(--text-muted)] text-xs tracking-[0.3em] uppercase">Loading driver roster…</span>
    </div>
  </section>

  <div id="charts-container" class="charts-grid">
    {% include "analytics/_charts.html" %}
  </div>
</div>

<script>
  // Store chart instances for cleanup
  window.chartInstances = {};

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
  });

  // Re-initialize charts after HTMX swap
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'charts-container') {
      loadAnalyticsData();
    }
  });

  function getSelectedDrivers() {
    const checkboxes = document.querySelectorAll('input[name="drivers"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }

  function buildApiUrl() {
    const base = '/api/v1/analytics/{{ season }}/{{ round }}';
    const drivers = getSelectedDrivers();
    if (drivers.length === 0) return base;
    const params = drivers.map(d => `drivers=${encodeURIComponent(d)}`).join('&');
    return `${base}?${params}`;
  }

  function loadAnalyticsData() {
    const url = buildApiUrl();

    // Show loading states
    document.querySelectorAll('.chart-container').forEach(el => {
      const canvas = el.querySelector('canvas');
      if (canvas) canvas.style.display = 'none';
      const loader = el.querySelector('.chart-loading');
      if (loader) loader.style.display = 'flex';
    });

    fetch(url)
      .then(r => r.json())
      .then(data => {
        // Populate driver filter
        populateDriverFilter(data.laps);
        updateHeroMetrics(data);

        // Render all charts
        renderLapTimeChart(data);
        renderPaceComparisonChart(data);
        renderStintTimelineChart(data);
        renderDriverGradesRadar(data);
      })
      .catch(err => {
        console.error('Failed to load analytics:', err);
        document.querySelectorAll('.chart-container').forEach(el => {
          const loader = el.querySelector('.chart-loading');
          if (loader) {
            loader.style.display = 'flex';
            loader.textContent = 'Failed to load data';
            loader.classList.add('chart-error');
          }
        });
      });
  }

  function populateDriverFilter(laps) {
    const drivers = [...new Set(laps.map(l => l.driver))].sort();
    const container = document.getElementById('driver-filter');

    if (container.dataset.populated === 'true') return;
    container.dataset.populated = 'true';

    const chipMarkup = drivers.map(driver => `
      <label class="driver-chip">
        <input type="checkbox" name="drivers" value="${driver}" checked onchange="onDriverFilterChange()">
        <span>${driver}</span>
      </label>
    `).join('');

    const actions = `
      <div class="chip-actions">
        <button type="button" onclick="selectAllDrivers()">All</button>
        <button type="button" onclick="selectNoDrivers()">Clear</button>
      </div>
    `;

    container.innerHTML = chipMarkup + actions;
  }

  function selectAllDrivers() {
    document.querySelectorAll('input[name="drivers"]').forEach(cb => cb.checked = true);
    onDriverFilterChange();
  }

  function selectNoDrivers() {
    document.querySelectorAll('input[name="drivers"]').forEach(cb => cb.checked = false);
    onDriverFilterChange();
  }

  let filterDebounce = null;
  function onDriverFilterChange() {
    clearTimeout(filterDebounce);
    filterDebounce = setTimeout(() => {
      loadAnalyticsData();
    }, 300);
  }

  function setMetric(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function updateHeroMetrics(data) {
    const laps = data.laps || [];
    const grades = data.driver_pace_grades || [];
    const stints = data.stints || [];

    const driverCount = new Set(laps.map(l => l.driver)).size || grades.length || 0;
    setMetric('metric-drivers', driverCount ? driverCount.toString().padStart(2, '0') : '--');

    const fastestLap = laps.reduce((min, lap) => {
      if (!lap.lap_ms || lap.lap_ms <= 0) return min;
      return Math.min(min, lap.lap_ms);
    }, Infinity);
    setMetric('metric-fastest', fastestLap !== Infinity ? `${(fastestLap / 1000).toFixed(3)}s` : '--.--s');

    const maxLap = laps.reduce((max, lap) => Math.max(max, lap.lap || 0), 0);
    setMetric('metric-laps', maxLap ? `1-${maxLap}` : '—');

    setMetric('metric-stints', stints.length ? stints.length.toString().padStart(2, '0') : '00');

    if (grades.length) {
      const avgDelta = grades.reduce((sum, g) => sum + (g.pace_delta_ms || 0), 0) / grades.length;
      setMetric('metric-delta', `+${(avgDelta / 1000).toFixed(3)}s`);
    } else {
      setMetric('metric-delta', '+0.000s');
    }
  }
</script>

{% include "components/_chart_scripts.html" %}
{% endblock %}
