services:
  # 1️⃣ Web (FastAPI)
  - type: web
    name: theundercut-web
    env: docker
    repo: https://github.com/alamine42/theundercut
    plan: free
    dockerCommand: uvicorn theundercut.api.main:app --host 0.0.0.0 --port $PORT

    # ─── shared env vars ──────────────────────────────
    envVars: &default_envvars
      - key: DATABASE_URL
        fromDatabase:
          name: theundercut-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: theundercut-cache
          property: connectionString
      - key: SECRET_KEY
        generateValue: true

    # ─── persistent disk for FastF1 cache ────────────
    disk: &default_disk
      name: data
      mountPath: /data
      sizeGB: 1            # you can grow this later

  # 2️⃣ Background worker (placeholder until we add RQ code)
  - type: worker
    name: theundercut-worker
    env: docker
    repo: https://github.com/alamine42/theundercut
    plan: free
    dockerCommand: python -c "print('worker placeholder')"
    envVars: *default_envvars
    disk:   *default_disk

  # 3️⃣ Redis‐compatible Key Value instance
  - type: keyvalue          # <- this defines Redis
    name: theundercut-cache
    plan: free

databases:
  - name: theundercut-db
    plan: free
    databaseName: theundercut
    user: theundercut
